# è®­ç»ƒä¼˜åŒ– v3.0 - å‚è€ƒtrains.pyç­–ç•¥

**æ—¥æœŸ**: 2026-01-31  
**ç›®æ ‡**: å°†å‡†ç¡®ç‡ä»69.94%æå‡è‡³75%+  
**å‚è€ƒ**: test/captcha_trainer/trains.pyï¼ˆTensorFlow 1.14è®­ç»ƒç­–ç•¥ï¼‰

---

## 1. å½“å‰é—®é¢˜åˆ†æ

### GPUè®­ç»ƒæ—¥å¿—åˆ†æ (Epoch 139)
- **å®Œæ•´åŒ¹é…å‡†ç¡®ç‡**: 69.94% âŒ (ç›®æ ‡75%+ï¼Œå·®è·5%)
- **å¬å›ç‡**: 93% âœ… (WeightedBCEå·²è§£å†³ç±»åˆ«ä¸å¹³è¡¡)
- **ç²¾ç¡®ç‡**: 94% âœ…
- **è®­ç»ƒæŸå¤±**: 0.0063
- **éªŒè¯æŸå¤±**: 0.0141 âš ï¸ **(è¿‡æ‹Ÿåˆæ¯”ä¾‹ 2.2x)**
- **å­¦ä¹ ç‡**: å·²è¡°å‡è‡³0.00015 (å¯èƒ½è¿‡ä½)

### å…³é”®é—®é¢˜
1. **è¿‡æ‹Ÿåˆä¸¥é‡**: éªŒè¯æŸå¤±æ˜¯è®­ç»ƒæŸå¤±çš„2.2å€
2. **å‡†ç¡®ç‡æ³¢åŠ¨**: 69-73%ä¹‹é—´éœ‡è¡ï¼Œæ— æ³•ç¨³å®šçªç ´
3. **å­¦ä¹ ç‡è¿‡ä½**: 0.00015å¯èƒ½å¯¼è‡´ä¼˜åŒ–åœæ»
4. **ç¼ºå°‘æ•°æ®å¢å¼º**: è®­ç»ƒé›†æ³›åŒ–èƒ½åŠ›ä¸è¶³

---

## 2. trains.pyæ ¸å¿ƒç­–ç•¥æå–

### å‚è€ƒä»£ç å…³é”®å‘ç°

#### 2.1 æ•°æ®é¢„å¤„ç†ç­–ç•¥
```python
# trains.py çš„æ•°æ®å¢å¼ºæ€è·¯ï¼ˆTF1.xå®ç°ï¼‰
- æ”¯æŒå›¾åƒé¢„å¤„ç†ï¼ˆresize, normalizeï¼‰
- ä½¿ç”¨TFRecordsé«˜æ•ˆæ•°æ®æµ
- æ‰¹é‡å¤„ç†ä¼˜åŒ–ï¼ˆbatch_size=64, validation_batch_size=300ï¼‰
```

#### 2.2 è®­ç»ƒå¾ªç¯ç­–ç•¥
```python
# trains.py çš„è®­ç»ƒæ§åˆ¶é€»è¾‘
- save_step=100: æ¯100æ­¥ä¿å­˜ä¸€æ¬¡æ¨¡å‹
- trains_validation_steps: æŒ‰æ­¥æ•°ï¼ˆè€Œéepochï¼‰è¿›è¡ŒéªŒè¯
- achieve_cond(): å¤šæ¡ä»¶ç»ˆæ­¢
  - acc >= end_acc AND
  - cost <= end_cost AND
  - epoch >= end_epochs
```

#### 2.3 æ­£åˆ™åŒ–ç­–ç•¥
```python
# trains.py çš„Dropouté…ç½®
- ä½¿ç”¨dropout=0.5ä½œä¸ºé»˜è®¤å€¼
- æ›´å¼ºçš„æ­£åˆ™åŒ–ä»¥é˜²æ­¢è¿‡æ‹Ÿåˆ
```

#### 2.4 å­¦ä¹ ç‡è°ƒæ•´
```python
# trains.py çš„å­¦ä¹ ç‡ç­–ç•¥
- learning_rateé…ç½®çµæ´»
- é€šè¿‡configåŠ¨æ€è°ƒæ•´
```

---

## 3. TF2.16.1é€‚é…ä¼˜åŒ–æ–¹æ¡ˆ

### 3.1 æ•°æ®å¢å¼º (å‡å°‘è¿‡æ‹Ÿåˆ â­â­â­)

**åˆ›å»º**: `caocrvfy/data_augmentation.py`

```python
# å‚è€ƒtrains.pyçš„æ•°æ®é¢„å¤„ç†æ€è·¯ï¼Œå®ç°TF2å¢å¼ºç­–ç•¥
def augment_image(image, training=True):
    if not training:
        return image
    
    # 1. éšæœºäº®åº¦è°ƒæ•´ï¼ˆ50%æ¦‚ç‡ï¼Œmax_delta=0.15ï¼‰
    # 2. éšæœºå¯¹æ¯”åº¦è°ƒæ•´ï¼ˆ50%æ¦‚ç‡ï¼Œ0.85-1.15ï¼‰
    # 3. éšæœºå™ªå£°ï¼ˆ30%æ¦‚ç‡ï¼Œstddev=0.015ï¼‰
    
    return image

def create_augmented_dataset(images, labels, batch_size, training):
    # ä½¿ç”¨tf.data.Dataseté«˜æ•ˆåŠ è½½
    # åº”ç”¨æ•°æ®å¢å¼ºpipeline
    # æ‰¹é‡å¤„ç† + é¢„å–ä¼˜åŒ–ï¼ˆAUTOTUNEï¼‰
```

**æ•ˆæœé¢„æœŸ**:
- å‡å°‘è¿‡æ‹Ÿåˆï¼ˆ2.2x â†’ 1.5xï¼‰
- æå‡æ³›åŒ–èƒ½åŠ›
- éªŒè¯é›†å‡†ç¡®ç‡æ›´ç¨³å®š

### 3.2 æ›´å¼ºæ­£åˆ™åŒ– (å‚è€ƒtrains.py â­â­)

**ä¿®æ”¹**: `caocrvfy/config.py` + `model_enhanced.py`

```python
# æå‡Dropoutæ¯”ä¾‹ï¼ˆå‚è€ƒtrains.pyçš„0.5é»˜è®¤å€¼ï¼‰
DROPOUT_CONV = 0.25  # 0.2 â†’ 0.25ï¼ˆå·ç§¯å±‚ï¼‰
DROPOUT_FC = 0.5     # 0.4 â†’ 0.5ï¼ˆå…¨è¿æ¥å±‚ï¼Œtrains.pyé»˜è®¤å€¼ï¼‰
```

**æ•ˆæœé¢„æœŸ**:
- é™ä½è¿‡æ‹Ÿåˆé£é™©
- æé«˜æ¨¡å‹é²æ£’æ€§

### 3.3 å­¦ä¹ ç‡å¿«é€Ÿå“åº” (å‚è€ƒtrains.py â­â­)

**ä¿®æ”¹**: `caocrvfy/train.py`

```python
# ReduceLROnPlateauä¼˜åŒ–
reduce_lr = ReduceLROnPlateau(
    patience=8,    # 10 â†’ 8ï¼ˆæ›´å¿«å“åº”ï¼Œå‚è€ƒtrains.pyï¼‰
    cooldown=2,    # 3 â†’ 2ï¼ˆå‡å°‘å†·å´æ—¶é—´ï¼‰
)
```

**åˆå§‹å­¦ä¹ ç‡è°ƒæ•´**:
```python
# config.py
LEARNING_RATE = 0.001  # 0.0012 â†’ 0.001ï¼ˆæ›´ç¨³å®šçš„èµ·ç‚¹ï¼‰
```

**æ•ˆæœé¢„æœŸ**:
- é¿å…å­¦ä¹ ç‡è¿‡æ—©åœæ»åœ¨æ¬¡ä¼˜è§£
- æ›´å¿«é€‚åº”è®­ç»ƒåŠ¨æ€

### 3.4 è®­ç»ƒæµç¨‹ä¼˜åŒ– (å‚è€ƒtrains.pyæ€è·¯ â­)

**ä¿®æ”¹**: `train.py` çš„ `train_model()`

```python
# ä½¿ç”¨Datasetæ›¿ä»£ç›´æ¥ä¼ é€’numpyæ•°ç»„
train_dataset = create_augmented_dataset(
    train_images, train_labels, 
    batch_size=128, 
    training=True
)
val_dataset = create_augmented_dataset(
    val_images, val_labels, 
    batch_size=128, 
    training=False
)

history = model.fit(
    train_dataset,  # ä½¿ç”¨Dataset
    validation_data=val_dataset,
    ...
)
```

**å‚è€ƒtrains.pyçš„éªŒè¯ç­–ç•¥** (æœªå®ç°ï¼Œå»ºè®®åç»­ä¼˜åŒ–):
- trains.pyä½¿ç”¨`trains_validation_steps`æŒ‰æ­¥æ•°éªŒè¯
- å½“å‰TF2ä½¿ç”¨epochçº§éªŒè¯ï¼ˆå·²è¶³å¤Ÿï¼‰
- å¦‚éœ€æè‡´ä¼˜åŒ–ï¼Œå¯å®ç°è‡ªå®šä¹‰éªŒè¯é¢‘ç‡

---

## 4. ä¼˜åŒ–æ•ˆæœé¢„æµ‹

### è¿‡æ‹Ÿåˆæ”¹å–„
| æŒ‡æ ‡ | å½“å‰ | é¢„æœŸ | æ”¹è¿› |
|------|------|------|------|
| è®­ç»ƒæŸå¤± | 0.0063 | ~0.010 | â†‘ (æ­£å¸¸ï¼Œæ›´å¼ºæ­£åˆ™åŒ–) |
| éªŒè¯æŸå¤± | 0.0141 | ~0.015 | â†‘ (gapç¼©å°) |
| æŸå¤±æ¯”ä¾‹ | 2.2x | 1.5x | âœ… å‡å°‘è¿‡æ‹Ÿåˆ |

### å‡†ç¡®ç‡æå‡
| æŒ‡æ ‡ | å½“å‰ | é¢„æœŸ | æ”¹è¿› |
|------|------|------|------|
| å®Œæ•´åŒ¹é… | 69.94% | **75-78%** | +5-8% â­ |
| å¬å›ç‡ | 93% | 94-95% | +1-2% |
| ç²¾ç¡®ç‡ | 94% | 95-96% | +1-2% |

### è®­ç»ƒç¨³å®šæ€§
- âœ… å‡å°‘å‡†ç¡®ç‡éœ‡è¡ï¼ˆ69-73% â†’ ç¨³å®šçˆ¬å‡ï¼‰
- âœ… å­¦ä¹ ç‡æ›´å¿«å“åº”plateau
- âœ… æ•°æ®å¢å¼ºæä¾›æ›´å¤šæœ‰æ•ˆè®­ç»ƒæ ·æœ¬

---

## 5. å®æ–½æ­¥éª¤

### 5.1 å·²å®Œæˆä¿®æ”¹
- [x] åˆ›å»º `data_augmentation.py`ï¼ˆæ•°æ®å¢å¼ºæ¨¡å—ï¼‰
- [x] æ›´æ–° `config.py`ï¼ˆDropout 0.25/0.5, LR=0.001ï¼‰
- [x] æ›´æ–° `model_enhanced.py`ï¼ˆDropouté…ç½®ï¼‰
- [x] æ›´æ–° `train.py`ï¼ˆå¯¼å…¥æ•°æ®å¢å¼ºï¼Œä¼˜åŒ–ReduceLRï¼‰
- [x] ä¿®æ”¹ `train_model()`ï¼ˆä½¿ç”¨augmented datasetï¼‰

### 5.2 éªŒè¯æµ‹è¯•
```bash
# 1. æµ‹è¯•æ•°æ®å¢å¼ºæ¨¡å—
python caocrvfy/data_augmentation.py

# 2. å¼€å§‹è®­ç»ƒ
python caocrvfy/train.py

# 3. è§‚å¯ŸæŒ‡æ ‡
# - éªŒè¯æŸå¤± / è®­ç»ƒæŸå¤± æ¯”ä¾‹æ˜¯å¦é™ä½
# - å®Œæ•´åŒ¹é…å‡†ç¡®ç‡æ˜¯å¦è¶…è¿‡75%
# - å­¦ä¹ ç‡è¡°å‡æ˜¯å¦æ›´åˆç†
```

---

## 6. trains.pyç­–ç•¥æ€»ç»“

### å¯ç›´æ¥åº”ç”¨çš„æ€è·¯
âœ… **æ•°æ®å¢å¼º**: å®ç°äº†TF2ç‰ˆæœ¬çš„å›¾åƒå¢å¼º  
âœ… **æ›´å¼ºæ­£åˆ™åŒ–**: Dropout 0.5å‚è€ƒtrains.pyé»˜è®¤å€¼  
âœ… **å­¦ä¹ ç‡å¿«é€Ÿè°ƒæ•´**: patience=8æ›´æ¿€è¿›çš„è¡°å‡ç­–ç•¥  
âœ… **tf.data.Dataset**: é«˜æ•ˆæ•°æ®æµæ›¿ä»£numpyæ•°ç»„  

### ä¸é€‚ç”¨äºTF2çš„éƒ¨åˆ†
âŒ **TFRecords**: TF2æ¨èä½¿ç”¨tf.data.Dataset + numpy  
âŒ **Session-based**: TF1.xçš„Sessionæ¨¡å¼ï¼ŒTF2ä½¿ç”¨Eager Execution  
âŒ **æ‰‹åŠ¨éªŒè¯å¾ªç¯**: TF2çš„model.fitå·²é›†æˆéªŒè¯é€»è¾‘  

### æ½œåœ¨åç»­ä¼˜åŒ–
ğŸ”„ **æŒ‰æ­¥æ•°éªŒè¯**: å½“å‰æŒ‰epochéªŒè¯ï¼Œtrains.pyæŒ‰æ­¥æ•°ï¼ˆå¯é€‰ï¼‰  
ğŸ”„ **å¤šæ¡ä»¶ç»ˆæ­¢**: achieve_cond()çš„é€»è¾‘ï¼ˆå¯é€šè¿‡è‡ªå®šä¹‰Callbackå®ç°ï¼‰  
ğŸ”„ **æ›´å¤§éªŒè¯batch**: trains.pyä½¿ç”¨300 vs è®­ç»ƒ64ï¼ˆTF2ä½¿ç”¨128ç»Ÿä¸€ï¼‰  

---

## 7. å…³é”®å·®å¼‚å¯¹æ¯”

| ç­–ç•¥ | trains.py (TF1.14) | å½“å‰TF2.16.1 (v3.0) |
|------|-------------------|-------------------|
| æ•°æ®å¢å¼º | é¢„å¤„ç† + TFRecords | âœ… tf.dataå¢å¼ºpipeline |
| Dropout | 0.5é»˜è®¤ | âœ… 0.25/0.5 (conv/fc) |
| å­¦ä¹ ç‡è¡°å‡ | é…ç½®çµæ´» | âœ… patience=8å¿«é€Ÿå“åº” |
| éªŒè¯é¢‘ç‡ | æŒ‰æ­¥æ•° | æŒ‰epochï¼ˆå·²è¶³å¤Ÿï¼‰ |
| æ‰¹é‡å¤§å° | 64 (train), 300 (val) | 128ç»Ÿä¸€ |
| æŸå¤±å‡½æ•° | BCE | âœ… WeightedBCE (pos_weight=3.0) |
| ç»ˆæ­¢æ¡ä»¶ | achieve_condå¤šæ¡ä»¶ | EarlyStoppingå•æ¡ä»¶ |

---

## 8. é¢„æœŸç»“æœ

### è®­ç»ƒæŒ‡æ ‡
- Epoch 100-150 é¢„æœŸè¾¾åˆ°75%+
- è¿‡æ‹Ÿåˆæ¯”ä¾‹é™è‡³1.5xä»¥å†…
- è®­ç»ƒæ›´ç¨³å®šï¼Œéœ‡è¡å‡å°‘

### æœ€ç»ˆæ€§èƒ½
```
ç›®æ ‡: å®Œæ•´åŒ¹é…å‡†ç¡®ç‡ 75-78%
â”œâ”€â”€ å½“å‰: 69.94% (Weighted BCEæ¢å¤)
â”œâ”€â”€ v3.0ä¼˜åŒ–: +5-8% (æ•°æ®å¢å¼º + æ›´å¼ºæ­£åˆ™åŒ–)
â””â”€â”€ å‚è€ƒGPUè®­ç»ƒ: 75.32% (æ ‡å‡†BCEï¼Œæ— æ•°æ®å¢å¼º)
```

### ä¼˜åŒ–è·¯å¾„
```
52.85% (Focal Losså¤±è´¥)
  â†“
69.94% (Weighted BCEæ¢å¤ï¼Œç±»åˆ«ä¸å¹³è¡¡è§£å†³)
  â†“
75-78% (v3.0: æ•°æ®å¢å¼º + trains.pyç­–ç•¥ä¼˜åŒ–) â† å½“å‰ç›®æ ‡
  â†“
80%+ (æ½œåœ¨: æ¨¡å‹æ¶æ„ä¼˜åŒ–ã€æ›´å¤šæ•°æ®)
```

---

## 9. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **è¿è¡Œæµ‹è¯•**: `python caocrvfy/data_augmentation.py`
2. **å¼€å§‹è®­ç»ƒ**: `python caocrvfy/train.py`
3. **ç›‘æ§æŒ‡æ ‡**:
   - éªŒè¯æŸå¤± / è®­ç»ƒæŸå¤± æ¯”ä¾‹
   - å®Œæ•´åŒ¹é…å‡†ç¡®ç‡è¶‹åŠ¿
   - å­¦ä¹ ç‡è¡°å‡æ—¶æœº
4. **GPUè®­ç»ƒ**: ä¸Šä¼ è‡³æœåŠ¡å™¨è¿è¡Œå®Œæ•´200 epochs
5. **æ•ˆæœéªŒè¯**: å¯¹æ¯”69.94% â†’ ç›®æ ‡75%+

---

**ç‰ˆæœ¬**: v3.0  
**ä¼˜åŒ–ä¾æ®**: test/captcha_trainer/trains.py (TensorFlow 1.14)  
**æ ¸å¿ƒç­–ç•¥**: æ•°æ®å¢å¼º + æ›´å¼ºæ­£åˆ™åŒ– + å¿«é€Ÿå­¦ä¹ ç‡è°ƒæ•´  
**é¢„æœŸæå‡**: +5-8% (69.94% â†’ 75-78%)
