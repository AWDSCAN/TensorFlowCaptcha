# æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯æµç¨‹å®ç°æ–‡æ¡£

ğŸ“… **åˆ›å»ºæ—¶é—´**: 2026-02-01  
ğŸ“ **ä½œè€…**: GitHub Copilot  
ğŸ¯ **ç›®çš„**: è§£å†³æ•°å­¦é¢˜éªŒè¯ç å‡†ç¡®ç‡ç“¶é¢ˆ

---

## ä¸€ã€é—®é¢˜èƒŒæ™¯

### 1.1 åŸå§‹é—®é¢˜
- **ç—‡çŠ¶**: è®­ç»ƒå‡†ç¡®ç‡å¡åœ¨ 78%ï¼Œæ— æ³•çªç ´
- **æ ¹å› **: 25% æ•°å­¦é¢˜éªŒè¯ç æ ‡ç­¾ä¸åŒ¹é…
  - æ–‡ä»¶å: `22-hash.png`ï¼ˆç­”æ¡ˆæ˜¯ 22ï¼‰
  - å›¾ç‰‡å†…å®¹: æ˜¾ç¤º `19+3=?`ï¼ˆé¢˜ç›®æœ¬èº«ï¼‰
  - **çŸ›ç›¾**: æ¨¡å‹è¢«è®­ç»ƒè¯†åˆ«ç­”æ¡ˆï¼Œä½†å®é™…å›¾ç‰‡æ˜¾ç¤ºçš„æ˜¯é¢˜ç›®

### 1.2 ç”¨æˆ·éœ€æ±‚
> "caocrvfyä¸­é’ˆå¯¹éªŒè¯ç å†…å®¹ç±»å‹ä¸ºæ•°å­¦è¿ç®—é¢˜ç±»å‹çš„éªŒè¯ç çš„è®­ç»ƒå’ŒéªŒè¯æ­¥éª¤åº”è¯¥ä¸º**å…ˆåˆ†æéªŒè¯ç ä¸­æ•°å­¦è¿ç®—é¢˜æœ¬èº«å†…å®¹è¯†åˆ«æ˜¯å¦æ­£ç¡®ï¼Œç„¶åç¬¬äºŒæ­¥æ˜¯å¯¹è¯†åˆ«å‡ºçš„æ•°å­¦è¿ç®—é¢˜å†…å®¹è¿›è¡Œè¿ç®—å¾—å‡ºç»“æœï¼Œç¬¬ä¸‰éƒ¨æ˜¯æ¯”å¯¹è¿™ä¸ªè¿ç®—ç»“æœå’ŒåŸå§‹éªŒè¯ç å›¾ç‰‡æ–‡ä»¶åç§°ä¸­çš„é¢„æœŸç»“æœæ˜¯å¦ä¸€è‡´**"

---

## äºŒã€è§£å†³æ–¹æ¡ˆæ¦‚è§ˆ

### 2.1 ä¸‰æ­¥éªŒè¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å›¾ç‰‡æ–‡ä»¶: MTkrMz0/_22_abc123.png                           â”‚
â”‚  å›¾ç‰‡å†…å®¹: [æ˜¾ç¤º "19+3=?"]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  æ­¥éª¤1: æ¨¡å‹è¯†åˆ«å›¾ç‰‡å†…å®¹      â”‚
           â”‚  è¯†åˆ«ç»“æœ: "19+3=?"          â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  åˆ¤æ–­: æ˜¯å¦ä¸ºæ•°å­¦è¡¨è¾¾å¼ï¼Ÿ     â”‚
           â”‚  æ£€æŸ¥: åŒ…å« +-*=? ç¬¦å·       â”‚
           â”‚  ç»“æœ: âœ“ True                â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  æ­¥éª¤2: è®¡ç®—æ•°å­¦è¡¨è¾¾å¼        â”‚
           â”‚  æ¸…ç†: "19+3=?" â†’ "19+3"     â”‚
           â”‚  è®¡ç®—: eval("19+3")          â”‚
           â”‚  ç»“æœ: "22"                  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  æ­¥éª¤3: æ¯”å¯¹é¢„æœŸç­”æ¡ˆ          â”‚
           â”‚  ä»æ–‡ä»¶åæå–: "22"          â”‚
           â”‚  æ¯”å¯¹: "22" == "22"          â”‚
           â”‚  ç»“æœ: âœ“ åŒ¹é…                â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
                    âœ“ éªŒè¯é€šè¿‡
```

### 2.2 æ ¸å¿ƒæ”¹åŠ¨

#### æ–‡ä»¶å‘½åæ ¼å¼å‡çº§
```python
# æ—§æ ¼å¼ï¼ˆé”™è¯¯ï¼‰
22-abc123.png  # æ–‡ä»¶åæ˜¯ç­”æ¡ˆï¼Œå›¾ç‰‡æ˜¯é¢˜ç›®

# æ–°æ ¼å¼ï¼ˆæ­£ç¡®ï¼‰
MTkrMz0/_22_abc123.png
â”œâ”€ MTkrMz0/: base64("19+3=?") - é¢˜ç›®ç¼–ç 
â”œâ”€ 22: é¢„æœŸç­”æ¡ˆ
â””â”€ abc123: éšæœºhash
```

#### å­—ç¬¦é›†æ‰©å±•
```python
# åŸå­—ç¬¦é›†
CHAR_SET = DIGITS + ALPHA_ALL + PADDING_CHAR  # 63ä¸ªå­—ç¬¦

# æ–°å­—ç¬¦é›†
MATH_OPERATORS = "+-*=?"
CHAR_SET = DIGITS + ALPHA_ALL + PADDING_CHAR + MATH_OPERATORS  # 68ä¸ªå­—ç¬¦
```

---

## ä¸‰ã€å®ç°ç»†èŠ‚

### 3.1 å·¥å…·å‡½æ•° (caocrvfy/core/utils.py)

#### å‡½æ•°1: `is_math_expression(text)`
**åŠŸèƒ½**: åˆ¤æ–­æ–‡æœ¬æ˜¯å¦ä¸ºæ•°å­¦è¡¨è¾¾å¼

```python
def is_math_expression(text):
    """åˆ¤æ–­æ–‡æœ¬æ˜¯å¦ä¸ºæ•°å­¦è¡¨è¾¾å¼"""
    math_operators = ['+', '-', '*', '=', '?']
    return any(op in text for op in math_operators)
```

**æµ‹è¯•ç»“æœ**:
```
âœ“ "19+3=?" â†’ True
âœ“ "ABCD"   â†’ False
âœ“ "1234"   â†’ False
```

#### å‡½æ•°2: `extract_answer_from_filename(filename)`
**åŠŸèƒ½**: ä»æ–‡ä»¶åæå–é¢„æœŸç­”æ¡ˆ

```python
def extract_answer_from_filename(filename):
    """ä»æ•°å­¦é¢˜æ–‡ä»¶åä¸­æå–é¢„æœŸç­”æ¡ˆ
    
    æ–‡ä»¶åæ ¼å¼: base64(é¢˜ç›®)_ç­”æ¡ˆ_hash.png
    è¿”å›: "22" æˆ– None
    """
    name_without_ext = os.path.splitext(os.path.basename(filename))[0]
    parts = name_without_ext.split('_')
    
    if len(parts) == 3:
        return parts[1]  # ç¬¬äºŒéƒ¨åˆ†æ˜¯ç­”æ¡ˆ
    
    return None
```

**æµ‹è¯•ç»“æœ**:
```
âœ“ "MTkrMz0/_22_abc123.png"  â†’ "22"
âœ“ "base64str_100_xyz789.png" â†’ "100"
âœ“ "oldformat.png"            â†’ None
```

#### å‡½æ•°3: `evaluate_math_expression(expression)`
**åŠŸèƒ½**: å®‰å…¨åœ°è®¡ç®—æ•°å­¦è¡¨è¾¾å¼

```python
def evaluate_math_expression(expression):
    """å®‰å…¨åœ°è®¡ç®—æ•°å­¦è¡¨è¾¾å¼
    
    å®‰å…¨æªæ–½:
    1. ç§»é™¤?å’Œ=ç¬¦å·
    2. æ­£åˆ™éªŒè¯åªåŒ…å«æ•°å­—å’Œè¿ç®—ç¬¦
    3. ä½¿ç”¨evalè®¡ç®—ï¼ˆå·²è¿‡æ»¤ï¼‰
    """
    # æ¸…ç†è¡¨è¾¾å¼
    clean_expr = expression.replace('?', '').replace('=', '').strip()
    
    # å®‰å…¨æ£€æŸ¥ï¼šåªå…è®¸æ•°å­—å’ŒåŸºæœ¬è¿ç®—ç¬¦
    if not re.match(r'^[\d\s\+\-\*\/\(\)\.]+$', clean_expr):
        return None
    
    try:
        result = eval(clean_expr)
        return str(int(result)) if result.is_integer() else str(result)
    except:
        return None
```

**å®‰å…¨ç‰¹æ€§**:
- âœ… æ­£åˆ™è¿‡æ»¤é˜²æ­¢ä»£ç æ³¨å…¥
- âœ… æµ‹è¯• `"1; drop table"` â†’ None (SQLæ³¨å…¥é˜²æŠ¤)
- âœ… å¼‚å¸¸æ•è·é˜²æ­¢å´©æºƒ

**æµ‹è¯•ç»“æœ**:
```
âœ“ "19+3=?"       â†’ "22"
âœ“ "100-50=?"     â†’ "50"
âœ“ "5*6=?"        â†’ "30"
âœ“ "2+3*4=?"      â†’ "14" (è¿ç®—é¡ºåº)
âœ“ "(2+3)*4=?"    â†’ "20" (æ‹¬å·)
âœ“ "1; drop table" â†’ None (å®‰å…¨æ£€æŸ¥)
```

#### å‡½æ•°4: `validate_math_captcha(predicted_text, expected_answer)`
**åŠŸèƒ½**: æ‰§è¡Œå®Œæ•´çš„ä¸‰æ­¥éªŒè¯

```python
def validate_math_captcha(predicted_text, expected_answer):
    """æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯
    
    è¿”å›: {
        'step1_recognized': bool,   # æ­¥éª¤1: æ˜¯å¦è¯†åˆ«ä¸ºæ•°å­¦è¡¨è¾¾å¼
        'step2_calculated': str,    # æ­¥éª¤2: è®¡ç®—ç»“æœ
        'step3_matched': bool,      # æ­¥éª¤3: æ˜¯å¦åŒ¹é…é¢„æœŸ
        'is_correct': bool          # æœ€ç»ˆæ˜¯å¦æ­£ç¡®
    }
    """
    result = {
        'step1_recognized': False,
        'step2_calculated': None,
        'step3_matched': False,
        'is_correct': False
    }
    
    # æ­¥éª¤1: æ£€æŸ¥æ˜¯å¦è¯†åˆ«ä¸ºæ•°å­¦è¡¨è¾¾å¼
    if not is_math_expression(predicted_text):
        return result
    
    result['step1_recognized'] = True
    
    # æ­¥éª¤2: è®¡ç®—æ•°å­¦è¡¨è¾¾å¼
    calculated_answer = evaluate_math_expression(predicted_text)
    result['step2_calculated'] = calculated_answer
    
    if calculated_answer is None:
        return result
    
    # æ­¥éª¤3: æ¯”å¯¹ç»“æœ
    if calculated_answer == expected_answer:
        result['step3_matched'] = True
        result['is_correct'] = True
    
    return result
```

**æµ‹è¯•ç»“æœ**:
```
âœ“ "19+3=?" vs "22" â†’ å…¨é€šè¿‡ (is_correct=True)
âœ“ "19+4=?" vs "22" â†’ æ­¥éª¤1âœ“, æ­¥éª¤2âœ“(23), æ­¥éª¤3âœ—
âœ“ "ABCD"   vs "22" â†’ æ­¥éª¤1âœ— (éæ•°å­¦é¢˜)
```

### 3.2 è¯„ä¼°å™¨å¢å¼º (caocrvfy/core/evaluator.py)

#### ä¿®æ”¹1: æ„é€ å‡½æ•°æ”¯æŒ image_paths
```python
def __init__(self, model, image_paths=None):
    """
    å‚æ•°:
        model: Kerasæ¨¡å‹
        image_paths: éªŒè¯å›¾ç‰‡è·¯å¾„åˆ—è¡¨ï¼ˆç”¨äºæå–é¢„æœŸç­”æ¡ˆï¼‰
    """
    self.model = model
    self.image_paths = image_paths
```

#### ä¿®æ”¹2: æ–°å¢ `evaluate_math_captcha()` æ–¹æ³•
```python
def evaluate_math_captcha(self, val_data, verbose=True):
    """æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯è¯„ä¼°
    
    è¾“å‡ºç»Ÿè®¡:
    - æ•°å­¦é¢˜éªŒè¯ç æ•°é‡
    - æ­¥éª¤1è¯†åˆ«å‡†ç¡®ç‡ (è¯†åˆ«ä¸ºæ•°å­¦è¡¨è¾¾å¼)
    - æ­¥éª¤2è®¡ç®—å‡†ç¡®ç‡ (æˆåŠŸè®¡ç®—ç»“æœ)
    - æ­¥éª¤3ç­”æ¡ˆå‡†ç¡®ç‡ (ç­”æ¡ˆå®Œå…¨æ­£ç¡®)
    - è¯¦ç»†éªŒè¯ç¤ºä¾‹ï¼ˆå‰10ä¸ªï¼‰
    
    è¿”å›: {
        'math_count': int,
        'step1_recognition_accuracy': float,
        'step2_calculation_accuracy': float,
        'step3_answer_accuracy': float,
        'math_details': list
    }
    """
    # ... å®ç°ä»£ç  ...
```

**è¾“å‡ºç¤ºä¾‹**:
```
========== æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯è¯„ä¼° ==========

æ•°å­¦é¢˜éªŒè¯ç æ•°é‡: 500

ä¸‰æ­¥éªŒè¯å‡†ç¡®ç‡:
  æ­¥éª¤1 - è¯†åˆ«ä¸ºæ•°å­¦è¡¨è¾¾å¼: 0.9500 (95.00%) [475/500]
  æ­¥éª¤2 - æˆåŠŸè®¡ç®—ç»“æœ:     0.9000 (90.00%) [450/500]
  æ­¥éª¤3 - ç­”æ¡ˆå®Œå…¨æ­£ç¡®:     0.8500 (85.00%) [425/500]

è¯¦ç»†ç¤ºä¾‹ï¼ˆå‰10ä¸ªï¼‰:
åºå·  æ–‡ä»¶å                    è¯†åˆ«ç»“æœ   è®¡ç®—ç­”æ¡ˆ  é¢„æœŸç­”æ¡ˆ  çŠ¶æ€
----  ----------------------  --------  --------  --------  ----
1     MTkrMz0/_22_abc.png     19+3=?    22        22        âœ“
2     NSpHPT0/_35_xyz.png     5*7=?     35        35        âœ“
...
```

#### ä¿®æ”¹3: æ›´æ–° `generate_report()` é›†æˆä¸‰æ­¥éªŒè¯
```python
def generate_report(self, val_data, include_math_validation=True):
    """ç”Ÿæˆå®Œæ•´çš„è¯„ä¼°æŠ¥å‘Šï¼ˆåŒ…å«æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯ï¼‰"""
    # è¯„ä¼°æ¨¡å‹
    metrics = self.evaluate(val_data, verbose=True)
    
    # æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯
    if include_math_validation and self.image_paths is not None:
        math_metrics = self.evaluate_math_captcha(val_data, verbose=True)
        if math_metrics is not None:
            metrics['math_validation'] = math_metrics
    
    # æ˜¾ç¤ºé¢„æµ‹ç¤ºä¾‹
    self.show_prediction_examples(val_data, num_examples=10, 
                                   show_math_validation=include_math_validation)
    
    return metrics
```

### 3.3 è®­ç»ƒè„šæœ¬é›†æˆ (caocrvfy/train_v4.py)

```python
# ========== æ­¥éª¤5: è¯„ä¼°æ¨¡å‹ ==========
print("æ­¥éª¤ 5/5: è¯„ä¼°æ¨¡å‹")
print("-" * 80)

# åˆ›å»ºè¯„ä¼°å™¨ï¼ˆä¼ å…¥image_pathsä»¥æ”¯æŒæ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯ï¼‰
evaluator = CaptchaEvaluator(
    model=trainer.get_model(),
    image_paths=loader.image_paths  # ç”¨äºæå–æ•°å­¦é¢˜é¢„æœŸç­”æ¡ˆ
)

# ç”Ÿæˆè¯„ä¼°æŠ¥å‘Šï¼ˆåŒ…å«æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯ï¼‰
metrics = evaluator.generate_report(
    val_data=(val_images, val_labels),
    include_math_validation=True  # å¯ç”¨æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯
)
```

---

## å››ã€æµ‹è¯•éªŒè¯

### 4.1 æµ‹è¯•è„šæœ¬
ğŸ“„ **æ–‡ä»¶**: `test_math_validation.py`

è¿è¡Œå‘½ä»¤:
```bash
cd tensorflow_cnn_captcha
python test_math_validation.py
```

### 4.2 æµ‹è¯•è¦†ç›–

âœ… **æµ‹è¯•1**: æ•°å­¦è¡¨è¾¾å¼è¯†åˆ« (6/6 é€šè¿‡)
- æ ‡å‡†æ•°å­¦é¢˜ã€ä¹˜æ³•é¢˜ã€å‡æ³•é¢˜
- çº¯å­—æ¯ã€çº¯æ•°å­—ã€æ··åˆå­—ç¬¦

âœ… **æµ‹è¯•2**: æ–‡ä»¶åç­”æ¡ˆæå– (4/4 é€šè¿‡)
- æ–°æ ¼å¼ã€æ—§æ ¼å¼ã€è¾¹ç•Œæƒ…å†µ

âœ… **æµ‹è¯•3**: æ•°å­¦è¡¨è¾¾å¼è®¡ç®— (9/9 é€šè¿‡)
- å››åˆ™è¿ç®—ã€è¿ç®—ä¼˜å…ˆçº§ã€æ‹¬å·
- å®‰å…¨æ£€æŸ¥ï¼ˆSQLæ³¨å…¥é˜²æŠ¤ï¼‰

âœ… **æµ‹è¯•4**: ä¸‰æ­¥éªŒè¯æµç¨‹ (6/6 é€šè¿‡)
- å®Œå…¨æ­£ç¡®ã€éƒ¨åˆ†é”™è¯¯ã€å®Œå…¨é”™è¯¯
- å„ç§ç»„åˆåœºæ™¯

âœ… **æµ‹è¯•5**: å®Œæ•´é›†æˆæµç¨‹ (4/4 é€šè¿‡)
- æ¨¡æ‹ŸçœŸå®è®­ç»ƒåœºæ™¯
- ä»æ–‡ä»¶ååˆ°éªŒè¯çš„å®Œæ•´æµç¨‹

**æ€»è®¡**: 5/5 æµ‹è¯•å¥—ä»¶å…¨éƒ¨é€šè¿‡ âœ…

### 4.3 æµ‹è¯•è¾“å‡ºæ‘˜è¦
```
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆ                              æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯æµ‹è¯•                             â–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

âœ“ é€šè¿‡: æ•°å­¦è¡¨è¾¾å¼è¯†åˆ«
âœ“ é€šè¿‡: æ–‡ä»¶åç­”æ¡ˆæå–
âœ“ é€šè¿‡: æ•°å­¦è¡¨è¾¾å¼è®¡ç®—
âœ“ é€šè¿‡: ä¸‰æ­¥éªŒè¯æµç¨‹
âœ“ é€šè¿‡: å®Œæ•´é›†æˆæµç¨‹

æ€»è®¡: 5/5 æµ‹è¯•é€šè¿‡

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä¸‰æ­¥éªŒè¯æµç¨‹å®ç°æ­£ç¡®ã€‚
```

---

## äº”ã€ä»£ç å˜æ›´æ€»ç»“

### 5.1 æ–°å¢æ–‡ä»¶
- `test_math_validation.py` - æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯æµ‹è¯•è„šæœ¬

### 5.2 ä¿®æ”¹æ–‡ä»¶

#### caocrvfy/core/utils.py
```diff
+ import re  # ç”¨äºæ•°å­¦è¡¨è¾¾å¼å®‰å…¨éªŒè¯

+ def is_math_expression(text):
+     """åˆ¤æ–­æ–‡æœ¬æ˜¯å¦ä¸ºæ•°å­¦è¡¨è¾¾å¼"""
+     ...

+ def extract_answer_from_filename(filename):
+     """ä»æ•°å­¦é¢˜æ–‡ä»¶åä¸­æå–é¢„æœŸç­”æ¡ˆ"""
+     ...

+ def evaluate_math_expression(expression):
+     """å®‰å…¨åœ°è®¡ç®—æ•°å­¦è¡¨è¾¾å¼"""
+     ...

+ def validate_math_captcha(predicted_text, expected_answer):
+     """æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯"""
+     ...
```
**æ–°å¢**: çº¦ 150 è¡Œä»£ç 

#### caocrvfy/core/evaluator.py
```diff
  def __init__(self, model, image_paths=None):
      """
      å‚æ•°:
          model: Kerasæ¨¡å‹
+         image_paths: éªŒè¯å›¾ç‰‡è·¯å¾„åˆ—è¡¨ï¼ˆç”¨äºæå–é¢„æœŸç­”æ¡ˆï¼‰
      """
      self.model = model
+     self.image_paths = image_paths

+ def evaluate_math_captcha(self, val_data, verbose=True):
+     """æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯è¯„ä¼°"""
+     ...

  def generate_report(self, val_data, include_math_validation=True):
      """ç”Ÿæˆå®Œæ•´çš„è¯„ä¼°æŠ¥å‘Šï¼ˆåŒ…å«æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯ï¼‰"""
+     if include_math_validation and self.image_paths is not None:
+         math_metrics = self.evaluate_math_captcha(val_data, verbose=True)
      ...
```
**æ–°å¢**: çº¦ 280 è¡Œä»£ç 

#### caocrvfy/train_v4.py
```diff
  # åˆ›å»ºè¯„ä¼°å™¨ï¼ˆæ¨¡å—åŒ–ï¼‰
  evaluator = CaptchaEvaluator(
      model=trainer.get_model(),
+     image_paths=loader.image_paths  # ç”¨äºæå–æ•°å­¦é¢˜é¢„æœŸç­”æ¡ˆ
  )
  
  # ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š
  metrics = evaluator.generate_report(
      val_data=(val_images, val_labels),
+     include_math_validation=True  # å¯ç”¨æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯
  )
```
**ä¿®æ”¹**: 2 å¤„è°ƒç”¨å¢å¼º

---

## å…­ã€ä½¿ç”¨æŒ‡å—

### 6.1 ç”Ÿæˆæ–°æ ¼å¼è®­ç»ƒæ•°æ®

ç¡®ä¿ `captcha/generate_captcha.py` å·²æ›´æ–°ä¸ºæ–°å‘½åæ ¼å¼ï¼š
```bash
cd captcha
python generate_captcha.py --count 20000
```

éªŒè¯æ–‡ä»¶å‘½å:
```bash
ls img/ | grep "_" | head -5
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼: MTkrMz0/_22_abc123.png
```

### 6.2 å¼€å§‹è®­ç»ƒ

```bash
cd caocrvfy
python train_v4.py
```

è®­ç»ƒå®Œæˆåï¼Œä¼šè‡ªåŠ¨æ˜¾ç¤ºï¼š
1. æ™®é€šå®Œæ•´åŒ¹é…å‡†ç¡®ç‡
2. æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯å‡†ç¡®ç‡
   - æ­¥éª¤1è¯†åˆ«ç‡
   - æ­¥éª¤2è®¡ç®—ç‡
   - æ­¥éª¤3ç­”æ¡ˆç‡

### 6.3 è§£è¯»è®­ç»ƒç»“æœ

**ç†æƒ³è¾“å‡ºç¤ºä¾‹**:
```
========== è¯„ä¼°ç»“æœ ==========
éªŒè¯é›†å®Œæ•´åŒ¹é…å‡†ç¡®ç‡: 0.8500 (85.00%)

========== æ•°å­¦é¢˜ä¸‰æ­¥éªŒè¯è¯„ä¼° ==========
æ•°å­¦é¢˜éªŒè¯ç æ•°é‡: 5000 (25% of 20000)

ä¸‰æ­¥éªŒè¯å‡†ç¡®ç‡:
  æ­¥éª¤1 - è¯†åˆ«ä¸ºæ•°å­¦è¡¨è¾¾å¼: 0.9800 (98.00%) â† é«˜è¯†åˆ«ç‡
  æ­¥éª¤2 - æˆåŠŸè®¡ç®—ç»“æœ:     0.9500 (95.00%) â† é«˜è®¡ç®—ç‡
  æ­¥éª¤3 - ç­”æ¡ˆå®Œå…¨æ­£ç¡®:     0.9200 (92.00%) â† ç›®æ ‡å‡†ç¡®ç‡
```

**è¯Šæ–­æŒ‡å—**:
- **æ­¥éª¤1ä½** (<80%): æ¨¡å‹æ²¡æœ‰å­¦ä¼šè¯†åˆ«æ•°å­¦ç¬¦å·ï¼Œæ£€æŸ¥å­—ç¬¦é›†é…ç½®
- **æ­¥éª¤2ä½** (<90%): è¯†åˆ«æ­£ç¡®ä½†è®¡ç®—å¤±è´¥ï¼Œé€šå¸¸æ˜¯æ­¥éª¤1è¯†åˆ«ä¸å¤Ÿç²¾ç¡®
- **æ­¥éª¤3ä½** (<85%): é¢˜ç›®è¯†åˆ«é”™è¯¯ï¼ˆå¦‚19+3è¯†åˆ«ä¸º19+4ï¼‰ï¼Œéœ€è¦æ›´å¤šè®­ç»ƒ

---

## ä¸ƒã€é¢„æœŸæ•ˆæœ

### 7.1 å‡†ç¡®ç‡æå‡é¢„æµ‹

| é˜¶æ®µ | æ€»ä½“å‡†ç¡®ç‡ | æ•°å­¦é¢˜å‡†ç¡®ç‡ | è¯´æ˜ |
|------|-----------|-------------|------|
| **ä¿®å¤å‰** | ~78% | ~50% | æ ‡ç­¾ä¸åŒ¹é…å¯¼è‡´ |
| **ä¿®å¤å** | >85% | >90% | ä¸‰æ­¥éªŒè¯æ­£ç¡®å®ç° |
| **æœ€ç»ˆç›®æ ‡** | >92% | >95% | å……åˆ†è®­ç»ƒå |

### 7.2 çªç ´ç“¶é¢ˆçš„å…³é”®

1. **æ ‡ç­¾ä¸€è‡´æ€§**: æ–‡ä»¶åç¼–ç é¢˜ç›®ï¼Œè€Œéç­”æ¡ˆ
2. **å­—ç¬¦é›†æ‰©å±•**: æ”¯æŒ +-*=? äº”ä¸ªè¿ç®—ç¬¦
3. **ç²¾å‡†éªŒè¯**: ä¸‰æ­¥éªŒè¯ç¡®ä¿æ¯ä¸ªç¯èŠ‚æ­£ç¡®
4. **æ•°æ®é‡å……è¶³**: 20000å¼ æ–°æ ¼å¼å›¾ç‰‡ï¼ˆ25%æ•°å­¦é¢˜ = 5000å¼ ï¼‰

---

## å…«ã€åç»­ä¼˜åŒ–å»ºè®®

### 8.1 çŸ­æœŸä¼˜åŒ–
- [ ] å¢åŠ æ•°å­¦é¢˜æ¯”ä¾‹åˆ° 30-40%
- [ ] æ·»åŠ æ›´å¤æ‚çš„è¿ç®—ï¼ˆæ‹¬å·ã€å¤šæ­¥ï¼‰
- [ ] ç›‘æ§ä¸‰æ­¥å‡†ç¡®ç‡è¶‹åŠ¿

### 8.2 é•¿æœŸä¼˜åŒ–
- [ ] åˆ†ç¦»æ•°å­¦é¢˜æ¨¡å‹ï¼ˆä¸“é—¨è®­ç»ƒï¼‰
- [ ] æ·»åŠ OCRåå¤„ç†ï¼ˆä¿®æ­£è¯†åˆ«é”™è¯¯ï¼‰
- [ ] å®ç°åœ¨çº¿å­¦ä¹ ï¼ˆæŒç»­æ”¹è¿›ï¼‰

---

## ä¹ã€æ–‡æ¡£ç»´æŠ¤

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´ |
|-----|------|------|------|
| v1.0 | 2026-02-01 | GitHub Copilot | åˆå§‹ç‰ˆæœ¬ |

**ç›¸å…³æ–‡æ¡£**:
- [æ•°å­¦é¢˜å‘½åæ›´æ–°](MATH_CAPTCHA_NAMING_UPDATE_2026-02-01.md)
- [è®­ç»ƒç“¶é¢ˆåˆ†æ](TRAINING_BOTTLENECK_ANALYSIS_2026-02-01.md)

---

## åã€å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦ä¸‰æ­¥éªŒè¯è€Œä¸æ˜¯ç›´æ¥æ¯”å¯¹ç­”æ¡ˆï¼Ÿ
**A**: 
- **å¯è¯Šæ–­æ€§**: èƒ½ç²¾ç¡®å®šä½å“ªä¸€æ­¥å‡ºé”™
- **å¯è§£é‡Šæ€§**: æ¸…æ¥šçŸ¥é“æ¨¡å‹åœ¨è¯†åˆ«ã€è®¡ç®—ã€è¿˜æ˜¯åŒ¹é…ç¯èŠ‚æœ‰é—®é¢˜
- **å¯ä¼˜åŒ–æ€§**: é’ˆå¯¹æ€§åœ°ä¼˜åŒ–è–„å¼±ç¯èŠ‚

### Q2: eval() ä¸æ˜¯ä¸å®‰å…¨å—ï¼Ÿ
**A**: 
- âœ… ä½¿ç”¨æ­£åˆ™ `r'^[\d\s\+\-\*\/\(\)\.]+$'` é¢„å…ˆè¿‡æ»¤
- âœ… æµ‹è¯•äº†SQLæ³¨å…¥ç­‰æ”»å‡»å‘é‡
- âœ… åªåœ¨å—æ§ç¯å¢ƒï¼ˆè®­ç»ƒè¯„ä¼°ï¼‰ä¸­ä½¿ç”¨
- âš ï¸  å¦‚æœç”¨äºç”Ÿäº§APIï¼Œå»ºè®®ä½¿ç”¨ `ast.literal_eval()` æˆ–ä¸“ç”¨è§£æå™¨

### Q3: ä¸ºä»€ä¹ˆæ­¥éª¤1ã€2ã€3çš„å‡†ç¡®ç‡ä¸åŒï¼Ÿ
**A**:
- **æ­¥éª¤1**: åªè¦åŒ…å«è¿ç®—ç¬¦å°±é€šè¿‡ï¼ˆæœ€å®½æ¾ï¼‰
- **æ­¥éª¤2**: éœ€è¦è¡¨è¾¾å¼æ ¼å¼æ­£ç¡®ä¸”å¯è®¡ç®—
- **æ­¥éª¤3**: éœ€è¦è®¡ç®—ç»“æœä¸é¢„æœŸå®Œå…¨ä¸€è‡´ï¼ˆæœ€ä¸¥æ ¼ï¼‰

æ‰€ä»¥: **æ­¥éª¤1å‡†ç¡®ç‡ â‰¥ æ­¥éª¤2å‡†ç¡®ç‡ â‰¥ æ­¥éª¤3å‡†ç¡®ç‡**

### Q4: å¦‚ä½•å¤„ç†éæ•°å­¦é¢˜éªŒè¯ç ï¼Ÿ
**A**: 
- é€šè¿‡ `extract_answer_from_filename()` è¿”å› None è‡ªåŠ¨è·³è¿‡
- éæ•°å­¦é¢˜ç»§ç»­ä½¿ç”¨åŸæœ‰çš„å®Œæ•´åŒ¹é…å‡†ç¡®ç‡
- ä¸¤ç§éªŒè¯ç ç±»å‹äº’ä¸å½±å“

---

**ğŸ‰ ä¸‰æ­¥éªŒè¯æµç¨‹å®ç°å®Œæˆï¼**

ä¸‹ä¸€æ­¥: ç”Ÿæˆè®­ç»ƒæ•°æ® â†’ å¼€å§‹è®­ç»ƒ â†’ çªç ´78%ç“¶é¢ˆ ğŸš€
