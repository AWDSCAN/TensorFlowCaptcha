# 训练优化快速启动指南 🚀

## 📝 已完成的优化 (阶段1)

### ✅ 1. 启用 Focal Loss
- **位置**: `trainer.py` → `recompile_with_lr_schedule()`
- **改动**: `use_focal_loss=True`, `focal_gamma=2.0`
- **效果**: 重点训练难分类样本（数学题、复杂字符）

### ✅ 2. 优化学习率策略
- **config.py**: 初始学习率 0.0008 → **0.001**
- **trainer.py**: 衰减间隔 10k步 → **15k步**, 衰减率 0.98 → **0.99**
- **效果**: 更快收敛 + 更平缓优化

### ✅ 3. 延长训练时间
- **callbacks.py**: `max_steps` 50k → **300k**
- **callbacks.py**: `validation_steps` 500 → **300** (更频繁验证)
- **callbacks.py**: `end_acc` 0.95 → **0.80** (更现实的目标)
- **callbacks.py**: `end_loss` 0.01 → **0.02**
- **效果**: 有足够时间达到收敛

### ✅ 4. 增强数据增强
- **data_augmentation.py**: 
  - 亮度调整概率 50% → **60%**, 幅度 ±10% → **±12%**
  - 对比度调整概率 50% → **60%**, 范围 90-110% → **85-115%**
- **效果**: 提升泛化能力，减少过拟合

---

## 🎯 预期效果对比

| 指标 | 优化前 | 预期优化后 |
|-----|-------|----------|
| 完整匹配准确率 | 63.81% | **75-82%** |
| 数学题识别率 | 1.75% | **15-30%** |
| 训练收敛步数 | 200k | 150-250k |
| 过拟合程度 | 中等 | 低 |

---

## 🚀 立即开始训练

### 方法1: 直接运行（推荐）
```bash
cd /data/coding/caocrvfy
python train_v4.py
```

### 方法2: 后台运行（长时间训练）
```bash
nohup python -u train_v4.py > training_$(date +%Y%m%d_%H%M%S).log 2>&1 &
```

### 方法3: 使用screen（可随时查看）
```bash
screen -S captcha_training
python train_v4.py
# Ctrl+A, D 分离会话
# screen -r captcha_training 恢复会话
```

---

## 📊 训练过程监控

### 关键指标
```
[Epoch N] 训练损失: 0.0141 | 验证损失: 0.0152 | 
          二进制准确率: 0.9975 | 完整匹配: 64.30% | 学习率: 0.000545
```

**重点关注**:
- ✅ **完整匹配准确率** > 75% → 优化成功
- ✅ **数学题识别率** > 15% → Focal Loss生效
- ⚠️ **验证损失持续上升** → 过拟合，需要早停
- ⚠️ **完整匹配停滞不前** → 考虑模型架构改进（阶段2）

### 每N步的验证输出
```
  📊 Step 197100 验证结果:
      验证损失: 0.0144 | 二进制准确率: 0.9976
      完整匹配: 66.50% | 学习率: 0.000545
```

**期望趋势**:
- 完整匹配率 **逐步提升** (每10k步 +1-2%)
- 验证损失 **平稳下降** (0.015 → 0.012 → 0.010)
- 学习率 **平缓衰减** (0.001 → 0.0005 → 0.0003)

---

## 🔧 训练中途调整

### 如果完整匹配率增长缓慢 (<70% after 150k steps):
1. **检查数据质量**: 
   ```bash
   python verify_training_data.py
   ```

2. **提升学习率**: 编辑 `config.py`
   ```python
   LEARNING_RATE = 0.0012  # 从0.001提升
   ```

3. **增强数据增强**: 编辑 `data_augmentation.py`
   ```python
   max_delta=0.15  # 从0.12提升
   ```

### 如果数学题识别仍然很差 (<10%):
1. **检查数学题样本数量**:
   ```bash
   ls -l /data/coding/captcha/img/ | grep -E "^[0-9a-f]{12}_[0-9]+_" | wc -l
   ```

2. **考虑生成更多数学题样本**:
   ```bash
   cd /data/coding/captcha
   python generate_captcha.py --type math --count 5000
   ```

3. **提升Focal Loss强度**: 编辑 `trainer.py`
   ```python
   focal_gamma=2.5  # 从2.0提升到2.5
   ```

---

## 📈 进阶优化 (如果阶段1效果不理想)

### 阶段2: 模型架构改进
见 `extras/model_grouped.py` - 分组输出模型
- 需要修改数据pipeline
- 预期提升: +5-10%

### 阶段3: 序列建模
添加LSTM/Transformer层
- 更复杂的架构
- 预期提升: +10-15%

---

## 🐛 常见问题

### Q1: 训练过程中断怎么办？
**A**: 训练会自动保存checkpoint
```bash
# 查看最新checkpoint
ls -lt models/checkpoint_step_*.keras | head -1

# 恢复训练（需要修改代码支持resume）
```

### Q2: GPU内存不足？
**A**: 降低batch size
```python
# config.py
BATCH_SIZE = 96  # 从128降低
```

### Q3: 想要更快看到效果？
**A**: 减少验证间隔
```python
# callbacks.py
validation_steps=200  # 从300降低到200
```

---

## 📝 训练日志分析

### 成功案例特征
```
Epoch 100/500
完整匹配: 68.20% ✓ (持续上升)
验证损失: 0.0132 ✓ (稳定下降)
训练损失: 0.0128 ✓ (与验证损失接近)
```

### 失败案例特征
```
Epoch 100/500
完整匹配: 64.50% ✗ (停滞不前)
验证损失: 0.0182 ✗ (开始上升)
训练损失: 0.0098 ✗ (远低于验证损失 - 过拟合)
```

---

## ✅ 验证优化是否生效

训练开始后，检查以下输出:

```
🎯 训练策略优化:
   - Focal Loss: 启用 (gamma=2.0, pos_weight=3.0)
   - 学习率: 0.001 → 每15k步×0.99衰减
   - 最大步数: 300000
   - 目标准确率: 80%
```

如果看到这些信息 → ✅ 优化已生效

---

**创建时间**: 2026-02-02  
**作者**: GitHub Copilot  
**状态**: 已部署，等待训练结果
